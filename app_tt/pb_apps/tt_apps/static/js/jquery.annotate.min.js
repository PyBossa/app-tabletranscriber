(function(a){a.fn.annotateImage=function(b){noteS=new Array();var c=a.extend({},a.fn.annotateImage.defaults,b);var d=this;this.image=this;this.mode="view";this.getUrl=c.getUrl;this.saveUrl=c.saveUrl;this.deleteUrl=c.deleteUrl;this.editable=c.editable;this.useAjax=c.useAjax;this.notes=c.notes;this.clear=c.clear;if(this.clear){a.fn.annotateImage.clear(this)}this.canvas=a('<div class="image-annotate-canvas"><div class="image-annotate-view"></div><div class="image-annotate-edit"><div class="image-annotate-edit-area"></div></div></div>');this.canvas.children(".image-annotate-edit").hide();this.canvas.children(".image-annotate-view").hide();this.image.after(this.canvas);this.canvas.height(this.height());this.canvas.width(this.width());this.canvas.css("background-image",'url("'+this.attr("src")+'")');this.canvas.children(".image-annotate-view, .image-annotate-edit").height(this.height());this.canvas.children(".image-annotate-view, .image-annotate-edit").width(this.width());this.canvas.hover(function(){if(a(this).children(".image-annotate-edit").css("display")=="none"){a(this).children(".image-annotate-view").show()}},function(){a(this).children(".image-annotate-view").hide()});this.canvas.children(".image-annotate-view").hover(function(){a(this).show()},function(){a(this).hide()});if(this.useAjax){a.fn.annotateImage.ajaxLoad(this)}else{a.fn.annotateImage.load(this)}if(this.editable){a.fn.annotateImage.mouseSelection(this)}this.hide();return this};a.fn.annotateImage.defaults={getUrl:"your-get.rails",saveUrl:"your-save.rails",deleteUrl:"your-delete.rails",editable:true,useAjax:true,clear:true,notes:new Array()};a.fn.annotateImage.clear=function(c){a("#image-annotate-edit-form").remove();a(".image-annotate-canvas").remove();for(var b=0;b<c.notes.length;b++){c.notes[c.notes[b]].destroy()}c.notes=new Array();noteS=new Array()};a.fn.annotateImage.ajaxLoad=function(b){a.getJSON(b.getUrl+"?ticks="+a.fn.annotateImage.getTicks(),function(c){b.notes=c;a.fn.annotateImage.load(b)})};a.fn.annotateImage.load=function(c){for(var b=0;b<c.notes.length;b++){c.notes[c.notes[b]]=new a.fn.annotateView(c,c.notes[b])}};a.fn.annotateImage.getTicks=function(){var b=new Date();return b.getTime()};a.fn.annotateImage.add=function(d,c){if(d.mode=="view"){d.mode="edit";var b=new a.fn.annotateEdit(d,false,c);a.fn.annotateImage.createSaveButton(b,d);a.fn.annotateImage.createCancelButton(b,d)}};a.fn.annotateImage.createSaveButton=function(c,e,d){var b=a('<a class="image-annotate-edit-ok">OK</a>');b.click(function(){var f=a("#image-annotate-edit-form form");var g={titulo:a("#titulo").val(),subtitulo:a("#subtitulo").val(),rodape:a("#rodape").val()};a.fn.annotateImage.appendPosition(f,c);e.mode="view";if(e.useAjax){a.ajax({url:e.saveUrl,data:f.serialize(),error:function(h){alert("An error occured saving that note.")},success:function(h){if(h.annotation_id!=undefined){c.note.id=h.annotation_id}},dataType:"json"})}if(d){d.resetPosition(c,g)}else{c.note.editable=true;c.note.text=g;d=new a.fn.annotateView(e,c.note);d.resetPosition(c,g);e.notes.push(c.note);a.fn.annotateImage.addNote(c.note)}c.destroy()});c.form.append(b)};a.fn.annotateImage.createCancelButton=function(b,d){var c=a('<a class="image-annotate-edit-close">Cancel</a>');c.click(function(){b.destroy();d.mode="view"});b.form.append(c)};a.fn.annotateImage.saveAsHtml=function(f,e){var d=a(e);var c="";for(var b=0;b<f.notes.length;b++){c+=a.fn.annotateImage.createHiddenField("text_"+b,f.notes[b].text);c+=a.fn.annotateImage.createHiddenField("top_"+b,f.notes[b].top);c+=a.fn.annotateImage.createHiddenField("left_"+b,f.notes[b].left);c+=a.fn.annotateImage.createHiddenField("height_"+b,f.notes[b].height);c+=a.fn.annotateImage.createHiddenField("width_"+b,f.notes[b].width)}d.html(c)};a.fn.annotateImage.createHiddenField=function(b,c){return'&lt;input type="hidden" name="'+b+'" value="'+c+'" /&gt;<br />'};a.fn.annotateEdit=function(g,c,f){this.image=g;if(c){this.note=c}else{var b=new Object();b.id="new";b.top=f.top;b.left=f.left;b.width=f.width;b.height=f.height;b.text={titulo:"",subtitulo:"",rodape:""};this.note=b}var e=g.canvas.children(".image-annotate-edit").children(".image-annotate-edit-area");this.area=e;this.area.css("height",this.note.height+"px");this.area.css("width",this.note.width+"px");this.area.css("left",this.note.left+"px");this.area.css("top",this.note.top+"px");g.canvas.children(".image-annotate-view").hide();g.canvas.children(".image-annotate-edit").show();var d=a('<div id="image-annotate-edit-form"><form>	Título: <textarea type="textarea" id="titulo" rows="0">'+this.note.text.titulo+'</textarea><br/>Subtítulo: <textarea type="textarea" id="subtitulo">'+this.note.text.subtitulo+'</textarea><br/>Rodapé: <textarea type="textarea" id="rodape">'+this.note.text.rodape+"</textarea></form></div>");this.form=d;a("body").append(this.form);this.form.css("left",this.area.offset().left+"px");this.form.css("top",(parseInt(this.area.offset().top)+parseInt(this.area.height())+7)+"px");e.resizable({handles:"all",stop:function(i,h){d.css("left",e.offset().left+"px");d.css("top",(parseInt(e.offset().top)+parseInt(e.height())+2)+"px")}}).draggable({containment:g.canvas,drag:function(i,h){d.css("left",e.offset().left+"px");d.css("top",(parseInt(e.offset().top)+parseInt(e.height())+2)+"px")},stop:function(i,h){d.css("left",e.offset().left+"px");d.css("top",(parseInt(e.offset().top)+parseInt(e.height())+2)+"px")}});return this};a.fn.annotateEdit.prototype.destroy=function(){this.image.canvas.children(".image-annotate-edit").hide();this.area.resizable("destroy");this.area.draggable("destroy");this.area.css("height","");this.area.css("width","");this.area.css("left","");this.area.css("top","");this.form.remove()};a.fn.annotateView=function(e,c){this.image=e;this.note=c;this.editable=(c.editable&&e.editable);this.area=a('<div class="image-annotate-area'+(this.editable?" image-annotate-area-editable":"")+'"><div></div></div>');e.canvas.children(".image-annotate-view").prepend(this.area);this.form=a('<div class="image-annotate-note">'+c.text.titulo+"</div>");this.form.hide();e.canvas.children(".image-annotate-view").append(this.form);this.form.children("span.actions").hide();this.setPosition();var b=this;this.area.hover(function(){b.show()},function(){b.hide()});if(this.editable){var d=this;if(d.form){this.area.click(function(){d.edit()})}}};a.fn.annotateView.prototype.setPosition=function(){this.area.children("div").height((parseInt(this.note.height)-2)+"px");this.area.children("div").width((parseInt(this.note.width)-2)+"px");this.area.css("left",(this.note.left)+"px");this.area.css("top",(this.note.top)+"px");this.form.css("left",(this.note.left)+"px");this.form.css("top",(parseInt(this.note.top)+parseInt(this.note.height)+7)+"px")};a.fn.annotateView.prototype.show=function(){this.form.fadeIn(250);if(!this.editable){this.area.addClass("image-annotate-area-hover")}else{this.area.addClass("image-annotate-area-editable-hover")}};a.fn.annotateView.prototype.hide=function(){this.form.fadeOut(250);this.area.removeClass("image-annotate-area-hover");this.area.removeClass("image-annotate-area-editable-hover")};a.fn.annotateView.prototype.destroy=function(){this.area.remove();this.form.remove()};a.fn.annotateView.prototype.edit=function(){if(this.image.mode=="view"){this.image.mode="edit";var b=this;var d=new a.fn.annotateEdit(this.image,this.note);a.fn.annotateImage.createSaveButton(d,this.image,b);var c=a('<a class="image-annotate-edit-delete">Delete</a>');c.click(function(){var e=a("#image-annotate-edit-form form");a.fn.annotateImage.appendPosition(e,d);if(b.image.useAjax){a.ajax({url:b.image.deleteUrl,data:e.serialize(),error:function(f){alert("An error occured deleting that note.")}})}b.image.mode="view";d.destroy();b.destroy();noteS=a.fn.annotateImage.removeNote(noteS,b.note)});d.form.append(c);a.fn.annotateImage.createCancelButton(d,this.image)}};a.fn.annotateImage.appendPosition=function(d,b){var c=a('<input type="hidden" value="'+b.area.height()+'" name="height"/><input type="hidden" value="'+b.area.width()+'" name="width"/><input type="hidden" value="'+b.area.position().top+'" name="top"/><input type="hidden" value="'+b.area.position().left+'" name="left"/><input type="hidden" value="'+b.note.id+'" name="id"/>');d.append(c)};a.fn.annotateView.prototype.resetPosition=function(b,c){this.form.html(c);this.form.hide();this.area.children("div").height(b.area.height()+"px");this.area.children("div").width((b.area.width()-2)+"px");this.area.css("left",(b.area.position().left)+"px");this.area.css("top",(b.area.position().top)+"px");this.form.css("left",(b.area.position().left)+"px");this.form.css("top",(parseInt(b.area.position().top)+parseInt(b.area.height())+7)+"px");this.note.top=b.area.position().top;this.note.left=b.area.position().left;this.note.height=b.area.height();this.note.width=b.area.width();this.note.text=c;this.note.id=b.note.id;this.editable=true};a.fn.annotateImage.mouseSelection=function(f){cont=0;intoNote=false;a("div.image-annotate-area-editable").live("mouseenter",function(){intoNote=true}).live("mouseleave",function(){intoNote=false});a("div.image-annotate-edit-area.ui-resizable.ui-draggable").live("mouseenter",function(){intoNote=true}).live("mouseleave",function(){intoNote=false});b(a(f).parent());function b(g){var h=g.offset();offsetLeft=h.left;offsetTop=h.top;maxWidth=offsetLeft+g.width();maxHeight=offsetTop+g.height();x1=0;y1=0;x2=0;y2=0;width=0;height=0;selTop=0;selLeft=0;g.unbind("mousedown").bind("mousedown",e)}function e(g){if(!intoNote){document.onselectstart=function(){return false};x1=g.pageX-offsetLeft;y1=g.pageY-offsetTop;a(this).append("<div id='mark"+cont+"' style='position: absolute; border: 1px inset; left: "+x1+"px; top: "+y1+"px;' ></div>");selectionDiv=a("#mark"+cont);a(document).mousemove(c).one("mouseup",d).unbind("mousedown")}}function c(g){if(g.pageX<offsetLeft){x2=0}else{if(g.pageX>maxWidth){x2=maxWidth-offsetLeft}else{x2=g.pageX-offsetLeft}}if(g.pageY<offsetTop){y2=0}else{if(g.pageY>maxHeight){y2=maxHeight-offsetTop}else{y2=g.pageY-offsetTop}}width=x2-x1;height=y2-y1;if(width<0&&height<0){selLeft=x2;selTop=y2;selectionDiv.css({left:selLeft,top:selTop,width:Math.abs(width),height:Math.abs(height),cursor:"crosshair"})}else{if(width<0){selLeft=x2;selTop=y1;selectionDiv.css({left:selLeft,top:selTop,width:Math.abs(width),height:Math.abs(height),cursor:"crosshair"})}else{if(height<0){selLeft=x1;selTop=y2;selectionDiv.css({left:selLeft,top:selTop,width:Math.abs(width),height:Math.abs(height),cursor:"crosshair"})}else{selLeft=x1;selTop=y1;selectionDiv.css({left:selLeft,top:selTop,width:Math.abs(width),height:Math.abs(height),cursor:"crosshair"})}}}}function d(h){a(document).unbind("mousemove");selectionDiv.remove();cont++;var g={top:selTop,left:selLeft,width:Math.abs(width),height:Math.abs(height)};a.fn.annotateImage.add(f,g)}};a.fn.annotateImage.addNote=function(b){noteS.push(b)};a.fn.annotateImage.removeNote=function(c,d){var f=a.inArray(d,c);var e=new Array();for(var b=0;b<c.length;b++){if(f==b){continue}e.push(c[b])}c=e;return c};a.fn.annotateImage.exportJsonData=function(){jsonData=[];for(var b=0;b<noteS.length;b++){jsonData.push({data:{titulo:noteS[b].text.titulo,subtitulo:noteS[b].text.subtitulo,rodape:noteS[b].text.rodape},coords:{x1:noteS[b].left,y1:noteS[b].top,x2:noteS[b].left+noteS[b].width,y2:noteS[b].top+noteS[b].height}})}return JSON.stringify(jsonData)}})(jQuery);